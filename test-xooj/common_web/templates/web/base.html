{% load i18n %}
{% load static %}
{% load static_v %}

<!DOCTYPE html>
<html>
<head>
    {% get_current_language as LANGUAGE_CODE %}
    <title id="platform_title">{{ request.system_name }} {% block title %}{% endblock %}</title>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="shortcut icon" href="{% static 'favicon.ico' %}">

    <link rel="stylesheet" href="{% static 'web/bootstrap-3.3.7/css/bootstrap.min.css' %}"/>
    <link rel="stylesheet" href="{% static 'web/css/bootstrap-table.css' %}"/>
    <link rel="stylesheet" href="{% static 'web/css/toastr.min.css' %}"/>
    <link rel="stylesheet" href="{% static 'web/font-awesome-4.7.0/css/font-awesome.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'web/summernote/summernote.css' %}">

    <link rel="stylesheet" href="{% static_v 'web/css/common.css' %}"/>
    <link rel="stylesheet" href="{% static_v 'web/css/default.css' %}"/>
    <link rel="stylesheet" href="{% static_v 'web/css/style.css' %}"/>
    <link rel="stylesheet" href="{% static 'web/css/ojicon.css' %}"/>
    <link rel="stylesheet" type="text/css" href="{% static_v 'x_person/css/info.css' %}"/>
    <link rel="stylesheet" type="text/css" href="{% static_v 'x_person/css/layout.css' %}"/>
    <link rel="stylesheet" href="{% static 'web/css/markdown.css' %}"/>

    <script type="text/javascript">
        var LANGUAGE_CODE = '{{ LANGUAGE_CODE }}';
        var isEn = {% if LANGUAGE_CODE == 'en' %}true{% else %}false{% endif %};
    </script>
    <script src="{% static "web/artTemplate/template.js" %}"></script>
    <script src="{% static 'lib/hplus/js/jquery.min.js' %}"></script>
{#    <script src="{% static 'web/js/jquery-3.2.1.min.js' %}"></script>#}
    <script src="{% static 'web/js/jquery.form.js' %}"></script>
    <script src="{% static 'web/js/jquery.md5.js' %}"></script>
    <script src="{% static 'web/js/jquery.validate.min.js' %}"></script>
    <script src="{% static 'web/js/messages_zh.min.js' %}"></script>
    <script src="{% static 'web/vue/vue.min.js' %}"></script>
    <script src="{% static 'web/js/echarts.min.js' %}"></script>
    <script src="{% static 'web/bootstrap-3.3.7/js/bootstrap.min.js' %}"></script>
    <script src="{% static 'web/summernote/summernote.js' %}"></script>
    {% if LANGUAGE_CODE == 'zh-hans' %}
        <script src="{% static 'web/summernote/lang/summernote-zh-CN.js' %}"></script>
    {% endif %}
    <script src="{% static 'web/js/bootstrap-table.js' %}"></script>
    {% if LANGUAGE_CODE == 'zh-hans' %}
        <script src="{% static 'web/js/bootstrap-table-zh-CN.js' %}"></script>
    {% endif %}
    <script src="{% static 'web/js/toastr.min.js' %}"></script>
    <script src="{% static 'web/js/autosize.js' %}"></script>


    <script src="{% static 'lib/jquery/jquery.filedrop.js' %}"></script>
    <script src="{% static 'lib/hplus/js/plugins/markdown/bootstrap-markdown.js' %}"></script>
    <link rel="stylesheet" type="text/css"
          href="{% static 'lib/hplus/css/plugins/markdown/bootstrap-markdown.min.css' %}"/>
    <script src="{% static 'lib/hplus/js/plugins/markdown/marked.js' %}"></script>

    <script type="text/javascript" src="{% url 'javascript-catalog' %}"></script>
    <script src="{% static "web/js/ajax.csrf.js" %}"></script>
    <script src="{% static_v 'web/js/utils.js' %}"></script>
    <script src="{% static 'web/js/form.utils.js' %}"></script>
    <script src="{% static 'web/js/error.message.js' %}"></script>
    <script src="{% static_v 'web/js/base.js' %}"></script>
    <script src="{% static_v 'web/js/common.js' %}"></script>
    <script src="{% static_v 'web/js/report_online.js' %}"></script>
    <script src="{% static 'x_person/js/uploadPreview.js' %}"></script>
    <script src="{% static 'x_person/js/common.js' %}"></script>

    {% if LANGUAGE_CODE == 'zh-hans' %}
    <script src="{% static 'lib/hplus/js/plugins/markdown/bootstrap-markdown.zh.js' %}"></script>
    {% else%}
    {% endif %}

    <style type="text/css">
        [v-cloak] {

            display: none;
        }

        .computer-icon {
            position: fixed;
            right: 15px;
            bottom: 15px;
            background: rgba(248, 134, 1, .3);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            text-align: center;
            line-height: 60px;
            border: 1px solid #f88601;
            cursor: pointer;

        }

        .computer-icon:hover {
            -webkit-animation: gelatine 0.5s 1;
            animation: gelatine 0.5s 1;
        }

        .scene-common-msg .mainBg {
            position: relative;
        }

        .scene-common-msg .mainBg .hide-link {
            position: absolute;
            right: 10px;
            font-size: 14px;
            cursor: pointer;
        }

        .scene-common-msg .hide-icon {
            font-size: 12px;
        }

        .scene-common-msg .hide-icon:first-child {
            margin-right: -11px;
            margin-left: -3px;
        }

        .scene-common-msg .text-no-wrap {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .scene-common-msg .text-no-wrap {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .scene-common-msg .scene-delete {
            width: 120px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            cursor: pointer;
            color: #ffffff;
            background-color: #ff0000;
        }

        .number-tips {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: #f80141;
            line-height: 20px;
            right: 0;
            border-radius: 50%;
            color: #fff;
            font-size: 12px;
        }

        .number-tips img {
            width: 30px;
            height: 30px;
        }

        .scene-common-msg::-webkit-scrollbar {
            display: none;
        }

        @keyframes gelatine {
            from, to {
                -webkit-transform: scale(1, 1);
                transform: scale(1, 1);
            }

            25% {
                -webkit-transform: scale(0.8, 1.2);
                transform: scale(0.8, 1.2);
            }

            50% {
                -webkit-transform: scale(1.2, 0.8);
                transform: scale(1.2, 0.8);
            }

            75% {
                -webkit-transform: scale(0.95, 1.05);
                transform: scale(0.95, 1.05);
            }

            from, to {
                -webkit-transform: scale(1, 1);
                transform: scale(1, 1);
            }

            25% {
                -webkit-transform: scale(0.8, 1.2);
                transform: scale(0.8, 1.2);
            }

            50% {
                -webkit-transform: scale(1.2, 0.8);
                transform: scale(1.2, 0.8);
            }

            75% {
                -webkit-transform: scale(0.95, 1.05);
                transform: scale(0.95, 1.05);
            }
        }

        @-webkit-keyframes gelatine {
            from, to {
                -webkit-transform: scale(1, 1);
                transform: scale(1, 1);
            }

            25% {
                -webkit-transform: scale(0.8, 1.1);
                transform: scale(0.8, 1.1);
            }

            50% {
                -webkit-transform: scale(1.1, 0.8);
                transform: scale(1.1, 0.8);
            }

            75% {
                -webkit-transform: scale(0.95, 1.05);
                transform: scale(0.95, 1.05);
            }

            from, to {
                -webkit-transform: scale(1, 1);
                transform: scale(1, 1);
            }

            25% {
                -webkit-transform: scale(0.8, 1.1);
                transform: scale(0.8, 1.1);
            }

            50% {
                -webkit-transform: scale(1.1, 0.8);
                transform: scale(1.1, 0.8);
            }

            75% {
                -webkit-transform: scale(0.95, 1.05);
                transform: scale(0.95, 1.05);
            }
        }
    </style>
    {% block other_css_js %}

    {% endblock %}
</head>
<body>
{% include "web/message_modal.html" %}
<!-- nav start -->
{% include 'web/nav.html' %}
<!-- nav end -->

<script>
    var imgUploadUrl = "{% url 'common_cms:common_upload_image' %}";
    var markdownUploadUrl = "{% url 'common_cms:common_upload_markdown' %}";
</script>

{% block container %}

{% endblock %}


{#    消息提示start#}
{% verbatim %}
<div id="scene" v-if="scenes.length > 0" v-cloak>
    <section class="scene-common-msg" style="z-index: 999;max-height: 67%;overflow-y: auto" :class="{'hidden': !isShowScenes}">
        <h2 class="mainBg whiteC">
            {{ 'x_ongoing_scene' | trans }}
            <span class="hide-link" @click="toggleScenes">{{ 'x_hide' | trans }}
                <span class="glyphicon glyphicon-menu-right hide-icon"></span>
                <span class="glyphicon glyphicon-menu-right hide-icon"></span>
            </span>
        </h2>

        <div class="scene-con scene-con-border-btm" v-for="scene in scenes">
            <div class="clearfix scenc-title">
                <img :src="scene.logo" class="pull-left" v-if="!scene.icon" style="width: 35px; height: 35px;"/>
                <i class="pull-left" :class="scene.icon" v-if="scene.icon"></i>
                <div class="pull-left" style="width: calc(100% - 60px);">
                    <p class="whiteC text-no-wrap">{{ scene.title }}</p>
                    <div class="text-no-wrap">{{ scene.detail }}</div>
                </div>
            </div>
            <div class="clearfix scene-btn-warp">
                <span class="pull-left orangeC scene-close hidden" :data-id="scene.id" @click="closeHint">{{ 'x_no_longer_reminding' | trans }}</span>
                <span class="pull-left scene-delete" :data-id="scene.id" @click="deleteScene" v-if="scene.delete_url">{{ 'x_delete_scene' | trans }}</span>
                <a class="pull-right mainBg  whiteC scene-back" :href="scene.url" target="_blank">{{
                    'x_click_to_go' | trans }} <i
                            class="oj-icon oj-icon-E967"></i>
                </a>
            </div>
        </div>
    </section>
    <div class="computer-icon" id="computer-icon" @click="toggleScenes">
        <span class="number-tips">{{ scenes.length }}</span>
        <img :src="countIconImg">
    </div>
</div>
{% endverbatim %}
<script>
    var usingEnvHint = (function (mod) {
        var userId = '{{ user.id }}';
        var currentScenes = [];
        var closedScenes = getClosedScenes(userId);

        var usingEnvVue;
        getUsingEnvObjects();

        function getUsingEnvObjects() {
            http.get('{% url "common_env:using_env_objects" %}', {}, function (res) {
                currentScenes.splice(0);
                $.each(res, function (i, scene) {
                    var uniqueId = generateUniqueSceneId(scene.id)
                    if ($.inArray(uniqueId, closedScenes) == -1 && window.location.pathname != scene.url) {
                        currentScenes.push(scene);
                    }
                });
                if (!usingEnvVue) {
                    usingEnvVue = new Vue({
                        el: '#scene',
                        data: {
                            scenes: currentScenes,
                            isShowScenes: false,
                            countIconImg: "{% static 'web/img/computer_icon.png' %}",
                        },
                        methods: {
                            closeHint: function (e) {
                                var id;
                                if (typeof e == 'string') {
                                    id = e;
                                } else {
                                    id = $(e.currentTarget).attr('data-id');
                                }
                                $.each(currentScenes, function (i, scene) {
                                    if (scene.id == id) {
                                        currentScenes.splice(i, 1);
                                        addClosedScene(userId, id);
                                        return;
                                    }
                                });
                            },
                            deleteScene: function (e) {
                                var id;
                                if (typeof e == 'string') {
                                    id = e;
                                } else {
                                    id = $(e.currentTarget).attr('data-id');
                                }
                                var scene = this.getSceneMap()[id];
                                iconfirm(gettext('x_confirm_delete_scene'), function () {
                                    http.delete(scene.delete_url, scene.delete_data, function () {
                                        usingEnvVue.closeHint(id);
                                    });
                                });
                            },
                            getSceneMap: function () {
                                var map = {};
                                $.each(this.scenes, function (i, scene) {
                                    map[scene.id] = scene;
                                });
                                return map;
                            },
                            toggleScenes: function (e) {
                                var prevStyles;
                                var nextStyles;
                                if (!this.isShowScenes) {
                                    prevStyles = {'right': '45px'};
                                    nextStyles = {'right': '-100px'};
                                } else {
                                    prevStyles = {'right': '-100px'};
                                    nextStyles = {'right': '45px'};
                                }
                                var prevIsShowScenes = this.isShowScenes;
                                if (prevIsShowScenes) {
                                    usingEnvVue.isShowScenes = !usingEnvVue.isShowScenes;
                                }
                                $('#computer-icon').animate(prevStyles).animate(nextStyles, function () {
                                    if (!prevIsShowScenes) {
                                        usingEnvVue.isShowScenes = !usingEnvVue.isShowScenes;
                                    }
                                });

                            },
                        }
                    });
                }
            });
        }

        // 重新提示所有场景
        mod.hintAllUsingEnvObjects = function () {
            closedScenes.splice(0);
            getUsingEnvObjects();
        };

        mod.addClosedScene = addClosedScene;

        // 获取已关闭的场景
        function getClosedScenes(userId) {
            var sceneConfig = pageUtil.getOptions('sceneConfig', true, true);
            var userClosedScenes = sceneConfig.userClosedScenes || {};
            var closedScenes = userClosedScenes[userId] || [];
            return closedScenes;
        }

        // 更新已关闭的场景
        function addClosedScene(userId, sceneId) {
            var sceneConfig = pageUtil.getOptions('sceneConfig', true, true);
            sceneConfig.userClosedScenes = sceneConfig.userClosedScenes || {};
            var closedScenes = sceneConfig.userClosedScenes[userId] = sceneConfig.userClosedScenes[userId] || [];
            var uniqueId = generateUniqueSceneId(sceneId);
            if ($.inArray(uniqueId, closedScenes) == -1) {
                closedScenes.push(uniqueId);
            }
            pageUtil.saveOptions('sceneConfig', sceneConfig, true, true);
        }

        // 生成唯一场景id
        function generateUniqueSceneId(sceneId) {
            return sceneId;
        }

        return mod;
    }(window.usingEnvHint || {}));
</script>
{#    消息提示start#}

{% block document_ready %}

{% endblock %}
<script>
    var rendererMD = new marked.Renderer();
    marked.setOptions({
        renderer: rendererMD,
        gfm: true,
        tables: true,
        breaks: true,
        pedantic: false,
        sanitize: false,
        smartLists: true,
        smartypants: false
    });
</script>
</body>
</html>